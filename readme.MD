# demo and notes
/
-docker-compose.yaml
    basic jenkins box that is using the default LTS (long term support) image
`docker-compose -f docker-compose.yaml up `#this runs interactively good for demo bad for usage
`docker-compose -f docker-compose.yaml up -d` # the -d send it backgroud to daemon mode
you will need the admin password you can get that with `docker exec -it jenkins cat /var/jenkins_home/secrets/initialAdminPassword`
or just run ./initialpassword.sh 
jenkins supplies a admin password that is autogenerated on first boot
inital setup will wlak you through what plugins you want
after you have done the plugin selection and had them all install properly lets dump out a config so we never have to do that again

``` curl -s -k "http://admin:admin@localhost:8080/pluginManager/api/json?depth=1" \
  | jq -r '.plugins[].shortName'
```
or
``` curl -s -k "http://admin:admin@localhost:8080/pluginManager/api/json?depth=1" \
  | jq -r '.plugins[].shortName' | tee plugins.txt
```
then we will have a list of plugins to use later.

give this a read and it will explain the process 
https://technologyconversations.com/2017/06/16/automating-jenkins-docker-setup/

create a groovy file with this
name it `security.groovy` why? cause thats the name jenkins wants.
```
#!groovy

import jenkins.model.*
import hudson.security.*
import jenkins.security.s2m.AdminWhitelistRule

def instance = Jenkins.getInstance()

def hudsonRealm = new HudsonPrivateSecurityRealm(false)
hudsonRealm.createAccount("admin", "admin")
instance.setSecurityRealm(hudsonRealm)

def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
instance.setAuthorizationStrategy(strategy)
instance.save()

Jenkins.instance.getInjector().getInstance(AdminWhitelistRule.class).setMasterKillSwitch(false)
```
or with 

```
#!groovy

import jenkins.model.*
import hudson.security.*
import jenkins.security.s2m.AdminWhitelistRule

def instance = Jenkins.getInstance()

def user = new File("/run/secrets/jenkins-user").text.trim()
def pass = new File("/run/secrets/jenkins-pass").text.trim()

def hudsonRealm = new HudsonPrivateSecurityRealm(false)
hudsonRealm.createAccount(user, pass)
instance.setSecurityRealm(hudsonRealm)

def strategy = new FullControlOnceLoggedInAuthorizationStrategy()
instance.setAuthorizationStrategy(strategy)
instance.save()

Jenkins.instance.getInjector().getInstance(AdminWhitelistRule.class).setMasterKillSwitch(false)
```
OR
go into custom and lets start building there.

## lets step in
custom/
Dockerfile
	has all the custom enhancements to build jenkins using the list of plugins and then a preset admin password.  
	means we can just spin up a new one whenever we want and not care

build.sh will do a docker build with the docker file and then tag it with `ridingintraffic/jenkins`

### lets go further
custom/did
Dockerfile
	this has all the same things as the prior dockerfile, however it installs a the binaries and daemon for docker inside of it. 
	This is going to allow us to have the jenkins build slaves run docker and build docker images.
	If you use a traditional jenkins build slave you are relying on the slave to have all the dependancies for all the commands and things that you would like to do.
	If you just build a docker container, or run a docker container from the build slave then you can test outside of jenkins on your local docker, and you never need to care what jenkins has installed because it has docker.

deep breath

jenkins running in docker, then jenkins running docker to build publish or run docker containers.
docker in docker to create docker.  

cause its just turtles all the way down

## make it so
run the `build.sh` script and it will tag the image `ridingintraffic/jenkins-did`
add the secrets for the docker contaner
```
echo "admin" | docker secret create jenkins-user -
echo "admin" | docker secret create jenkins-pass -
```
then stand it up with `docker-compose -f docker-compose.yaml up -d` 
it will use the tagged image, and then bind the docker socket through the inner docker daemon and bind it to the docker host, and attach the secrets to the container to set the username and password



## load up jenkins
add a git repo
jenkinsfile
	you will never write this right on the first try 
	the syntax is all google and for what i usually do `sh` commands
	there is a lot of other plugin style stuff that can be done but it gets messy and if im just doing docker things then ill just use a shell anyway

### disclaimer
docker sockets are dangerous and you should read about it
https://medium.com/lucjuggery/about-var-run-docker-sock-3bfd276e12fd
https://dejandayoff.com/the-danger-of-exposing-docker.sock/

